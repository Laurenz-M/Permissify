<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeScript HTML Example</title>
</head>
<body style="margin: 0">
<div class="site-container">
    <div class="camera-stream-container">
        <canvas id="canvas"></canvas>
        <video
        id="video"
        autoplay
        muted
        playsinline
        disablepictureinpicture
        style="background-color:black; object-fit: cover; width: 100%; height: 100%; overflow: hidden; margin: 0px; border: 0px solid red"></video>
    </div>
    <div class="camera-overlay" style="display: grid; grid-template-rows: 1fr auto">
        <div style="display: grid; place-items: center;">
            <div id="preview-photo-container" class="on-photo-preview" style="z-index: 5; object-fit: cover; visibility: hidden; display: grid; place-items: center;">
                <img id="preview-img" style="width: 100%;height: 100%; object-fit: cover"/>
            </div>
        </div>
        <div class="overlay-navbar" style="z-index:1; display: grid; grid-template-columns: 1fr 1fr 1fr">
            <div style="display: grid; place-items: center">
                <div id="photo-list-container" style=" border-radius: 5px; border: 2px solid white; overflow: hidden; aspect-ratio: 1/1; width: 50%">
                    <img id="photo-list-image" style="width: 100%; object-fit: cover; border: 0px transparent"/>
                </div>
            </div>
            <div style="display: grid; place-items: center">
                <div id="photo-button" style="display: grid; place-items: center; background-color: red; padding: 20px; aspect-ratio: 1/1; border-radius: 100%">
                    Foto
                </div>
            </div>
            <div></div>
        </div>
    </div>
    <div style="position: absolute; top: 0;height: 100%; width: 100%; z-index: 0; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);">
        <div style="border-right: 1px solid white; border-bottom: 1px solid white"></div>
        <div style="border-bottom: 1px solid white"></div>
        <div style="border-left: 1px solid white; border-bottom: 1px solid white"></div>

        <div style="border-right: 1px solid white;"></div>
        <div></div>
        <div style="border-left: 1px solid white;"></div>

        <div style="border-right: 1px solid white; border-top: 1px solid white"></div>
        <div style="border-top: 1px solid white"></div>
        <div style="border-left: 1px solid white; border-top: 1px solid white"></div>
    </div>
    <div id="pictures-tray" style="display: grid; grid-template-rows: auto 1fr; visibility: hidden; position: absolute; height: 100%; width: 100%; top: 0; z-index: 6; background-color: black; opacity: 0.7">
        <div style="padding-bottom: 20px; width: 100%; display: flex; justify-content: end">
            <div id="picture-tray-close-button" style="border: 1px solid white; margin-right: 10px; margin-top: 10px; width: 10%; aspect-ratio: 1/1; background-color: gray; border-radius: 100%; opacity: 1; display: flex; align-items: center; justify-content: center">
                <div style="font-family: 'Arial'; color: white">X</div>
            </div>
        </div>
        <div id="pictures-tray-wrapper" style="overflow: auto;max-width: 100%; column-gap: 15px; row-gap: 30px; display: grid; grid-template-columns: repeat(3, 1fr); padding: 20px">
        </div>
    </div>
</div>
<script type="module">
    const images = []
    let photoButtonLocked = false
    import {CameraPermissionHandler} from "../dist/CameraPermissionHandler.js";
    async function init() {
        console.log('test')
        const idealCameraConstraints = { video: { height: { ideal: window.innerHeight * 2 }, facingMode: { ideal: 'environment' } } };
        const handler = new CameraPermissionHandler()
        const res = await handler.initHandler(idealCameraConstraints)
        console.log(res)
        if(!res.permissionGranted) {
            return
        }
        const videoElem = document.getElementById('video')
        if(!videoElem) return
        videoElem.srcObject = res.request.result.stream
        const settings = res.request.result.stream.getVideoTracks()[0].getSettings();
        console.log(settings);
        const photoButton = document.getElementById('photo-button')
        photoButton.addEventListener('click', takePicture)
        const photoListContainer = document.getElementById('photo-list-container')
        photoListContainer.addEventListener('click', openPhotoList)
        const tray = document.getElementById('pictures-tray')
        const trayClose = document.getElementById('picture-tray-close-button')
        trayClose.addEventListener('click', () => { tray.style.visibility = 'hidden' })
        //setTimeout(animatePhoto, 3000)
    }
    init()
    function cameraShutterEffect() {
        const video = document.getElementById('video')
        video.style.visibility = 'hidden'
        setTimeout(() => {
            video.style.visibility = 'visible'
        },100)
    }
    function takePicture() {
        if(photoButtonLocked) return
        photoButtonLocked = true
        cameraShutterEffect()
        setTimeout(showPreviewOnPhoto, 100)
        const canvas = document.getElementById('canvas')
        const video = document.getElementById('video')
        const previewImg = document.getElementById('preview-img')
        if(!canvas || !video) throw new Error('Canvas not found')
        const context = canvas.getContext("2d");
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        canvas.width = window.innerWidth; // or any specific value for 9:16 screen
        canvas.height = videoHeight //720//window.innerHeight; // or any specific value


        const cropX = (videoWidth - canvas.width) / 2

            context.drawImage(video, cropX, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);

            const data = canvas.toBlob((blob) => {
                images.push(blob)
                //const file = new File([blob], 'test.png')
                const blobUrl = URL.createObjectURL(blob);
                previewImg.src = blobUrl
                const link = document.createElement("a");
                link.download = 'image.png';
                link.href = blobUrl;
                setTimeout(animatePhoto, 200)
                //setTimeout(,2000)
                //animatePhoto()
                //link.click();
            },"image/png");
            //photo.setAttribute("src", data);
    }
    function animatePhoto() {
        const list = document.getElementById('photo-list-container')
        const preview = document.getElementById('preview-photo-container')
        const previewImg = document.getElementById('preview-img')
        const {width, height, x,y, bottom} = list.getBoundingClientRect()
        const duration = 0.6// * 10
        preview.style.transition = `width ${duration}s, height ${duration}s, left ${duration}s, top ${duration}s, bottom ${duration}s, border-width ${duration / 2}s, border-radius ${duration / 2}s`
        preview.style.position = 'absolute'
        preview.style.borderWidth = '0px'
        preview.style.borderRadius = '5px'
        preview.style.left = `${x+1}px`
        preview.style.bottom = `${(window.innerHeight - y - height) +2}px`
        preview.style.width = `${width-2}px`
        preview.style.height = `${height-2}px`
        setTimeout(() => {
            //reset preview
            updateVisualPhotoList()
            resetPhotoPreview(preview)
            previewImg.src = undefined
            photoButtonLocked = false
        }, duration * 1000)
    }
    function resetPhotoPreview(htmlElement) {
        htmlElement.style.visibility = 'hidden'
        htmlElement.style.transition = ``
        htmlElement.style.position = 'absolute'
        htmlElement.style.borderWidth = '0px'
        htmlElement.style.borderRadius = '0px'
        htmlElement.style.left = ``
        htmlElement.style.bottom = ``
        htmlElement.style.width = ``
        htmlElement.style.height = ``
    }
    function showPreviewOnPhoto() {
        const video = document.getElementById('video')
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        const preview = document.getElementById('preview-photo-container')
        preview.style.visibility = 'visible'
        preview.style.border = "5px solid white"
        preview.style.borderRadius = '10px'
        preview.style.width = '76%'
        preview.style.height = `${videoHeight * 0.76}px`

    }
    function updateVisualPhotoList() {
        const listImg = document.getElementById('photo-list-image')
        listImg.src = URL.createObjectURL(images[images.length - 1])
    }
    function openPhotoList() {
        const photoListImage = document.getElementById('photo-list-image')
        console.log(photoListImage.src)
        const picturesTray = document.getElementById('pictures-tray')
        const picturesTrayWrapper = document.getElementById('pictures-tray-wrapper')
        picturesTray.style.visibility = 'visible'
        picturesTrayWrapper.childNodes.forEach(n => picturesTrayWrapper.removeChild(n))
        for(let i = 0; i < images.length; i++) {
            const imgSrc = images[i]
            const newImg = document.createElement('img')
            newImg.style.maxWidth = '100%'
            newImg.src = URL.createObjectURL(imgSrc)
            newImg.addEventListener('click', () => {
                images.splice(i, 1)
                picturesTrayWrapper.removeChild(newImg)
                if(images.length === 0) {
                    picturesTray.style.visibility = 'hidden'
                    const photoListImage = document.getElementById('photo-list-image')
                    photoListImage.src = ''
                }
            })
            picturesTrayWrapper.appendChild(newImg)
        }
    }
</script>
</body>
<style>
    .site-container {
        width: 100dvw;
        height: 100dvh;
        background-color: black;
        margin: 0;
    }
    .camera-stream-container {
        height: 100%;
        width: 100%;
        overflow: hidden;
    }
    .camera-overlay {
        top: 0;
        position: absolute;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }
    .overlay-navbar {
        width: 100%;
        margin-bottom: 25px;
    }
    #canvas {
        height: 100%;
        width: 100%;
        display: none;
    }
    .on-photo-preview {
        position: absolute;
        bottom: 20%;
        left: 12%;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }
</style>
</html>